# ======================================
# CONFIGURACIÓN GLOBAL
# ======================================
global:
  # Configuración de imágenes
  registry: "ghcr.io/samub96/ecommerce"
  imageTag: "latest"
  imagePullPolicy: "IfNotPresent"
  
  # Configuración de entorno
  environment: "production"  # development, staging, production
  timezone: "UTC"
  
  # Configuración de namespace
  namespace: "ecommerce-production"
  
  # Labels globales
  labels:
    app: "ecommerce"
    version: "v0.1.0"
    component: "microservice"
    part-of: "ecommerce-platform"
    managed-by: "helm"
  
  # Anotaciones globales
  annotations:
    deployment.kubernetes.io/revision: "1"
    meta.helm.sh/release-name: "ecommerce"

# ======================================
# CONFIGURACIÓN DE MICROSERVICIOS
# ======================================
microservices:
  # API Gateway
  api-gateway:
    enabled: true
    name: "api-gateway"
    image: "api-gateway"
    port: 8080
    replicas: 3
    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "1Gi"
        cpu: "500m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8080"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8080
      initialDelaySeconds: 45
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8080
  
  # User Service
  user-service:
    enabled: true
    name: "user-service"
    image: "user-service"
    port: 8081
    replicas: 2
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8081"
      - name: SPRING_DATASOURCE_URL
        value: "jdbc:mysql://mysql-users:3306/users_db?useSSL=true&serverTimezone=UTC"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8081
      initialDelaySeconds: 60
      periodSeconds: 10
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8081
  
  # Product Service
  product-service:
    enabled: true
    name: "product-service"
    image: "product-service"
    port: 8082
    replicas: 2
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8082"
      - name: SPRING_DATASOURCE_URL
        value: "jdbc:mysql://mysql-products:3306/products_db?useSSL=true&serverTimezone=UTC"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8082
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8082
  
  # Order Service
  order-service:
    enabled: true
    name: "order-service"
    image: "order-service"
    port: 8083
    replicas: 2
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8083"
      - name: SPRING_DATASOURCE_URL
        value: "jdbc:mysql://mysql-orders:3306/orders_db?useSSL=true&serverTimezone=UTC"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8083
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8083
  
  # Payment Service
  payment-service:
    enabled: true
    name: "payment-service"
    image: "payment-service"
    port: 8084
    replicas: 2
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8084"
      - name: SPRING_DATASOURCE_URL
        value: "jdbc:mysql://mysql-payments:3306/payments_db?useSSL=true&serverTimezone=UTC"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8084
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8084
  
  # Shipping Service
  shipping-service:
    enabled: true
    name: "shipping-service"
    image: "shipping-service"
    port: 8085
    replicas: 2
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8085"
      - name: SPRING_DATASOURCE_URL
        value: "jdbc:mysql://mysql-shipping:3306/shipping_db?useSSL=true&serverTimezone=UTC"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8085
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8085
  
  # Favourite Service
  favourite-service:
    enabled: true
    name: "favourite-service"
    image: "favourite-service"
    port: 8086
    replicas: 2
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8086"
      - name: SPRING_DATASOURCE_URL
        value: "jdbc:mysql://mysql-favourites:3306/favourites_db?useSSL=true&serverTimezone=UTC"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8086
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8086
  
  # Service Discovery (Eureka)
  service-discovery:
    enabled: true
    name: "service-discovery"
    image: "service-discovery"
    port: 8761
    replicas: 1
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8761"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8761
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8761
  
  # Cloud Config
  cloud-config:
    enabled: true
    name: "cloud-config"
    image: "cloud-config"
    port: 8888
    replicas: 1
    resources:
      requests:
        memory: "256Mi"
        cpu: "150m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8888"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8888
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8888
  
  # Proxy Client
  proxy-client:
    enabled: true
    name: "proxy-client"
    image: "proxy-client"
    port: 8090
    replicas: 1
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "200m"
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: "production"
      - name: SERVER_PORT
        value: "8090"
    healthCheck:
      enabled: true
      path: "/actuator/health"
      port: 8090
    service:
      type: "ClusterIP"
      port: 80
      targetPort: 8090

# ======================================
# CONFIGURACIÓN DE INGRESS
# ======================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: "/"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
  hosts:
    - host: "ecommerce.example.com"
      paths:
        - path: "/"
          pathType: "Prefix"
          backend:
            service:
              name: "api-gateway"
              port:
                number: 80
    - host: "admin.ecommerce.example.com"
      paths:
        - path: "/"
          pathType: "Prefix"
          backend:
            service:
              name: "api-gateway"
              port:
                number: 80
  tls:
    - secretName: "ecommerce-tls"
      hosts:
        - "ecommerce.example.com"
        - "admin.ecommerce.example.com"

# ======================================
# CONFIGURACIÓN DE CANARY DEPLOYMENT
# ======================================
canary:
  enabled: false
  # Configuración de Flagger para Canary Deployments
  flagger:
    enabled: false
    provider: "nginx"
    targetRef:
      apiVersion: "apps/v1"
      kind: "Deployment"
      name: "api-gateway"
    service:
      port: 80
      targetPort: 8080
    analysis:
      enabled: true
      interval: "30s"
      threshold: 5
      maxWeight: 50
      stepWeight: 10
      metrics:
        - name: "request-success-rate"
          thresholdRange:
            min: 99
          interval: "30s"
        - name: "request-duration"
          thresholdRange:
            max: 500
          interval: "30s"
      webhooks:
        - name: "load-test"
          url: "http://load-test.default/"
          timeout: "15s"
          metadata:
            cmd: "hey -z 1m -q 10 -c 2 http://api-gateway.ecommerce-production/"
  
  # Configuración manual de canary
  weight: 10
  analysis:
    threshold: 99.5
    stepWeight: 10
    maxWeight: 50

# ======================================
# CONFIGURACIÓN DE BASES DE DATOS
# ======================================
mysql:
  enabled: true
  auth:
    rootPassword: "root-secure-password"
    database: "ecommerce_main"
    username: "ecommerce_user"
    password: "ecommerce-secure-password"
  architecture: "replication"
  secondary:
    replicaCount: 1
  primary:
    persistence:
      enabled: true
      size: "20Gi"
      storageClass: "fast-ssd"
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

redis:
  enabled: true
  auth:
    enabled: true
    password: "redis-secure-password"
  architecture: "replication"
  replica:
    replicaCount: 2
  master:
    persistence:
      enabled: true
      size: "10Gi"
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# ======================================
# CONFIGURACIÓN DE MESSAGING
# ======================================
rabbitmq:
  enabled: true
  auth:
    username: "ecommerce"
    password: "rabbitmq-secure-password"
  replicaCount: 2
  persistence:
    enabled: true
    size: "10Gi"
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# ======================================
# CONFIGURACIÓN DE ELASTICSEARCH
# ======================================
elasticsearch:
  enabled: false
  master:
    replicaCount: 3
  data:
    replicaCount: 2
  coordinating:
    replicaCount: 2
  persistence:
    enabled: true
    size: "30Gi"

# ======================================
# CONFIGURACIÓN DE MONITORING
# ======================================
monitoring:
  enabled: true
  prometheus:
    enabled: true
    scrapeInterval: "15s"
    evaluationInterval: "15s"
  grafana:
    enabled: true
    adminPassword: "admin-secure-password"
    dashboards:
      enabled: true
  jaeger:
    enabled: true
    collector:
      resources:
        requests:
          memory: "256Mi"
          cpu: "150m"
    query:
      resources:
        requests:
          memory: "256Mi"
          cpu: "150m"

# ======================================
# CONFIGURACIÓN DE AUTOSCALING
# ======================================
autoscaling:
  enabled: true
  hpa:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  vpa:
    enabled: false
  keda:
    enabled: false

# ======================================
# CONFIGURACIÓN DE SEGURIDAD
# ======================================
security:
  networkPolicies:
    enabled: true
  podSecurityPolicy:
    enabled: true
  rbac:
    enabled: true
  serviceAccount:
    create: true
    annotations: {}
    name: ""
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

# ======================================
# CONFIGURACIÓN DE STORAGE
# ======================================
storage:
  storageClass: "fast-ssd"
  accessMode: "ReadWriteOnce"
  backup:
    enabled: true
    schedule: "0 2 * * *"
    retention: "30d"

# ======================================
# NODE SELECTORS Y TOLERATIONS
# ======================================
nodeSelector: {}
tolerations: []
affinity: {}

# ======================================
# CONFIGURACIÓN DE PRUEBAS
# ======================================
tests:
  enabled: true
  image: "bats/bats:1.8.2"