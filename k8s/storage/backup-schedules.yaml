# ============================================================================
# BACKUP SCHEDULES - PROGRAMACI√ìN AUTOM√ÅTICA DE BACKUPS
# ============================================================================

# Backup completo diario del namespace de ecommerce
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: ecommerce-daily-backup
  namespace: velero-system
  labels:
    app: velero
    component: scheduled-backup
    backup-type: daily
spec:
  schedule: "0 2 * * *"  # Todos los d√≠as a las 2 AM
  template:
    metadata:
      name: "ecommerce-daily-{{ .Date }}"
      labels:
        backup-type: daily
        environment: production
        application: ecommerce
    spec:
      # Incluir namespaces espec√≠ficos
      includedNamespaces:
      - ecommerce-production
      - ecommerce-staging
      
      # Incluir recursos cr√≠ticos
      includedResources:
      - persistentvolumes
      - persistentvolumeclaims
      - secrets
      - configmaps
      - deployments
      - services
      - ingresses
      - statefulsets
      - jobs
      - cronjobs
      
      # Excluir recursos no cr√≠ticos
      excludedResources:
      - events
      - pods
      - replicasets
      - endpoints
      
      # Configuraci√≥n de volumes
      defaultVolumesToFsBackup: true
      
      # Hooks para backup consistente de bases de datos
      hooks:
        resources:
        - name: mysql-backup-hook
          includedNamespaces:
          - ecommerce-production
          - ecommerce-staging
          includedResources:
          - pods
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: mysql
          pre:
          - exec:
              command:
              - /bin/bash
              - -c
              - |
                echo "üóÑÔ∏è Starting MySQL backup preparation..."
                # Flush tables and get read lock
                mysql -u root -p$MYSQL_ROOT_PASSWORD -e "FLUSH TABLES WITH READ LOCK;"
                echo "‚úÖ MySQL tables locked for consistent backup"
              container: mysql
              onError: Fail
              timeout: 60s
          post:
          - exec:
              command:
              - /bin/bash
              - -c
              - |
                echo "üîì Releasing MySQL read lock..."
                mysql -u root -p$MYSQL_ROOT_PASSWORD -e "UNLOCK TABLES;"
                echo "‚úÖ MySQL backup preparation completed"
              container: mysql
              onError: Continue
              timeout: 30s
        
        - name: redis-backup-hook
          includedNamespaces:
          - ecommerce-production
          - ecommerce-staging
          includedResources:
          - pods
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: redis
          pre:
          - exec:
              command:
              - /bin/bash
              - -c
              - |
                echo "üîÑ Starting Redis backup preparation..."
                redis-cli BGSAVE
                echo "‚úÖ Redis background save initiated"
              container: redis
              onError: Continue
              timeout: 30s
      
      # Configuraci√≥n de TTL y storage
      ttl: 720h  # 30 d√≠as
      storageLocation: default
      volumeSnapshotLocations:
      - default
      
      # Configuraci√≥n de snapshot
      snapshotVolumes: true
      includeClusterResources: true
      
      # Configuraci√≥n de ordering
      orderedResources:
        persistentvolumes: persistentvolumeclaims,secrets,configmaps
        secrets: deployments,statefulsets
        configmaps: deployments,statefulsets

---
# Backup semanal completo con retenci√≥n extendida
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: ecommerce-weekly-full-backup
  namespace: velero-system
  labels:
    app: velero
    component: scheduled-backup
    backup-type: weekly
spec:
  schedule: "0 1 * * 0"  # Domingos a la 1 AM
  template:
    metadata:
      name: "ecommerce-weekly-{{ .Date }}"
      labels:
        backup-type: weekly
        environment: production
        application: ecommerce
        retention: long-term
    spec:
      # Backup completo de todo el cluster
      includedNamespaces: []  # Todos los namespaces
      
      # Excluir solo namespaces de sistema no cr√≠ticos
      excludedNamespaces:
      - kube-node-lease
      - kube-public
      
      # Incluir todos los recursos cr√≠ticos
      includedResources: []  # Todos los recursos
      
      # Excluir recursos temporales
      excludedResources:
      - events
      - pods
      - replicasets
      - endpoints
      - endpointslices
      
      # Configuraci√≥n de volumes
      defaultVolumesToFsBackup: true
      snapshotVolumes: true
      includeClusterResources: true
      
      # TTL extendido para backups semanales
      ttl: 2160h  # 90 d√≠as
      storageLocation: default
      volumeSnapshotLocations:
      - default
      
      # Hooks m√°s completos para backup semanal
      hooks:
        resources:
        - name: pre-backup-validation
          includedNamespaces:
          - ecommerce-production
          includedResources:
          - pods
          pre:
          - exec:
              command:
              - /bin/bash
              - -c
              - |
                echo "üîç Pre-backup validation starting..."
                echo "Timestamp: $(date)"
                echo "Namespace: $VELERO_NAMESPACE"
                echo "Pod: $HOSTNAME"
                df -h
                echo "‚úÖ Pre-backup validation completed"
              onError: Continue
              timeout: 60s

---
# Backup incremental cada 6 horas
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: ecommerce-incremental-backup
  namespace: velero-system
  labels:
    app: velero
    component: scheduled-backup
    backup-type: incremental
spec:
  schedule: "0 */6 * * *"  # Cada 6 horas
  template:
    metadata:
      name: "ecommerce-incremental-{{ .Date }}"
      labels:
        backup-type: incremental
        environment: production
        application: ecommerce
    spec:
      # Solo namespaces de aplicaci√≥n para backups incrementales
      includedNamespaces:
      - ecommerce-production
      
      # Solo recursos que cambian frecuentemente
      includedResources:
      - configmaps
      - secrets
      - deployments
      - services
      - jobs
      - cronjobs
      
      # Configuraci√≥n ligera para backups incrementales
      defaultVolumesToFsBackup: false
      snapshotVolumes: false
      includeClusterResources: false
      
      # TTL m√°s corto para backups incrementales
      ttl: 168h  # 7 d√≠as
      storageLocation: default
      
      # Label selector para cambios recientes
      labelSelector:
        matchExpressions:
        - key: backup.kubernetes.io/exclude
          operator: NotIn
          values: ["true"]

---
# Backup de configuraci√≥n cr√≠tica (secrets, configmaps)
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: ecommerce-config-backup
  namespace: velero-system
  labels:
    app: velero
    component: scheduled-backup
    backup-type: configuration
spec:
  schedule: "*/30 * * * *"  # Cada 30 minutos
  template:
    metadata:
      name: "ecommerce-config-{{ .Date }}"
      labels:
        backup-type: configuration
        environment: production
        application: ecommerce
    spec:
      # Todos los namespaces para configuraci√≥n
      includedNamespaces:
      - ecommerce-production
      - ecommerce-staging
      - velero-system
      - cert-manager
      - ingress-nginx
      - sealed-secrets
      
      # Solo recursos de configuraci√≥n
      includedResources:
      - secrets
      - configmaps
      - certificates
      - issuers
      - clusterissuers
      - sealedsecrets
      
      # Sin volumes para backups de configuraci√≥n
      defaultVolumesToFsBackup: false
      snapshotVolumes: false
      includeClusterResources: true
      
      # TTL corto para configuraci√≥n (rotaci√≥n r√°pida)
      ttl: 72h  # 3 d√≠as
      storageLocation: default

---
# Backup pre-deployment para rollback r√°pido
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: ecommerce-pre-deployment-backup
  namespace: velero-system
  labels:
    app: velero
    component: scheduled-backup
    backup-type: pre-deployment
spec:
  schedule: "0 */2 * * *"  # Cada 2 horas (antes de posibles deployments)
  template:
    metadata:
      name: "ecommerce-pre-deploy-{{ .Date }}"
      labels:
        backup-type: pre-deployment
        environment: production
        application: ecommerce
        purpose: rollback
    spec:
      # Solo production para pre-deployment
      includedNamespaces:
      - ecommerce-production
      
      # Recursos cr√≠ticos para rollback
      includedResources:
      - deployments
      - statefulsets
      - services
      - ingresses
      - configmaps
      - secrets
      - persistentvolumeclaims
      
      # Configuraci√≥n optimizada para rollback r√°pido
      defaultVolumesToFsBackup: true
      snapshotVolumes: true
      includeClusterResources: false
      
      # TTL optimizado para rollbacks (1 semana)
      ttl: 168h  # 7 d√≠as
      storageLocation: default
      volumeSnapshotLocations:
      - default
      
      # Hooks para estado consistente antes del deployment
      hooks:
        resources:
        - name: pre-deployment-state
          includedNamespaces:
          - ecommerce-production
          includedResources:
          - pods
          labelSelector:
            matchLabels:
              app.kubernetes.io/part-of: ecommerce-platform
          pre:
          - exec:
              command:
              - /bin/bash
              - -c
              - |
                echo "üì∏ Capturing pre-deployment state..."
                echo "Current deployment version: $(env | grep VERSION || echo 'unknown')"
                echo "Pod restart count: $(cat /proc/1/stat | cut -d' ' -f22 || echo 'unknown')"
                echo "Available memory: $(cat /proc/meminfo | grep MemAvailable || echo 'unknown')"
                echo "‚úÖ Pre-deployment state captured"
              onError: Continue
              timeout: 30s