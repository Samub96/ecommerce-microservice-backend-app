# ============================================================================
# MYSQL MASTER-SLAVE REPLICATION PARA ALTA DISPONIBILIDAD
# ============================================================================

# ConfigMap para configuraci√≥n de MySQL Master
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-master-config
  namespace: ecommerce-production
  labels:
    app: mysql
    component: database
    tier: master
data:
  my.cnf: |
    [mysqld]
    # === Configuraci√≥n Master-Slave ===
    server-id = 1
    log-bin = mysql-bin
    binlog-format = ROW
    binlog-do-db = users_db,products_db,orders_db,payments_db,shipping_db,favourites_db
    
    # === Configuraci√≥n de Performance ===
    innodb_buffer_pool_size = 1G
    innodb_log_file_size = 256M
    innodb_log_buffer_size = 64M
    innodb_flush_log_at_trx_commit = 1
    innodb_file_per_table = 1
    
    # === Configuraci√≥n de Conexiones ===
    max_connections = 200
    max_connect_errors = 10
    thread_cache_size = 50
    table_open_cache = 2048
    
    # === Configuraci√≥n de Seguridad ===
    bind-address = 0.0.0.0
    skip-name-resolve
    sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO
    
    # === Configuraci√≥n de Backup ===
    backup_type = master
    
    # === Configuraci√≥n SSL ===
    ssl-ca = /etc/mysql/ssl/ca.pem
    ssl-cert = /etc/mysql/ssl/server-cert.pem
    ssl-key = /etc/mysql/ssl/server-key.pem
    require_secure_transport = ON
    
    # === Configuraci√≥n de Monitoring ===
    performance_schema = ON
    slow_query_log = ON
    slow_query_log_file = /var/log/mysql/slow.log
    long_query_time = 2
    log_queries_not_using_indexes = ON
    
    # === Configuraci√≥n de Timezone ===
    default-time-zone = '+00:00'
    
    [mysql]
    default-character-set = utf8mb4
    
    [mysqldump]
    single-transaction
    routines
    triggers
---
# ConfigMap para configuraci√≥n de MySQL Slave
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-slave-config
  namespace: ecommerce-production
  labels:
    app: mysql
    component: database
    tier: slave
data:
  my.cnf: |
    [mysqld]
    # === Configuraci√≥n Master-Slave ===
    server-id = 2
    relay-log = relay-bin
    log-bin = mysql-bin
    binlog-format = ROW
    replicate-do-db = users_db,products_db,orders_db,payments_db,shipping_db,favourites_db
    
    # === Configuraci√≥n Slave espec√≠fica ===
    read_only = 1
    super_read_only = 1
    slave_skip_errors = 1062,1032
    relay_log_purge = 1
    relay_log_recovery = 1
    
    # === Configuraci√≥n de Performance ===
    innodb_buffer_pool_size = 1G
    innodb_log_file_size = 256M
    innodb_log_buffer_size = 64M
    innodb_flush_log_at_trx_commit = 2
    innodb_file_per_table = 1
    
    # === Configuraci√≥n de Conexiones ===
    max_connections = 100
    max_connect_errors = 10
    thread_cache_size = 50
    table_open_cache = 2048
    
    # === Configuraci√≥n de Seguridad ===
    bind-address = 0.0.0.0
    skip-name-resolve
    sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO
    
    # === Configuraci√≥n SSL ===
    ssl-ca = /etc/mysql/ssl/ca.pem
    ssl-cert = /etc/mysql/ssl/server-cert.pem
    ssl-key = /etc/mysql/ssl/server-key.pem
    require_secure_transport = ON
    
    # === Configuraci√≥n de Monitoring ===
    performance_schema = ON
    slow_query_log = ON
    slow_query_log_file = /var/log/mysql/slow.log
    long_query_time = 2
    
    # === Configuraci√≥n de Timezone ===
    default-time-zone = '+00:00'
    
    [mysql]
    default-character-set = utf8mb4

---
# MySQL Master StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-master
  namespace: ecommerce-production
  labels:
    app: mysql
    component: database
    tier: master
spec:
  serviceName: mysql-master
  replicas: 1
  selector:
    matchLabels:
      app: mysql
      tier: master
  template:
    metadata:
      labels:
        app: mysql
        component: database
        tier: master
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9104"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
      initContainers:
      # Init container para configurar permisos
      - name: init-mysql-master
        image: mysql:8.0
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          echo "üîß Initializing MySQL Master..."
          
          # Crear directorios necesarios
          mkdir -p /var/lib/mysql/mysql
          mkdir -p /var/log/mysql
          
          # Configurar permisos
          chown -R mysql:mysql /var/lib/mysql
          chown -R mysql:mysql /var/log/mysql
          chmod 755 /var/lib/mysql
          chmod 755 /var/log/mysql
          
          echo "‚úÖ MySQL Master initialization completed"
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-logs
          mountPath: /var/log/mysql
      containers:
      # MySQL Master container
      - name: mysql
        image: mysql:8.0
        imagePullPolicy: IfNotPresent
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretRef:
              name: database-sealed-secrets
              key: mysql-root-password
        - name: MYSQL_REPLICATION_USER
          value: "replicator"
        - name: MYSQL_REPLICATION_PASSWORD
          valueFrom:
            secretRef:
              name: database-sealed-secrets
              key: mysql-replication-password
        - name: MYSQL_DATABASE
          value: "ecommerce_main"
        ports:
        - name: mysql
          containerPort: 3306
          protocol: TCP
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
            - -u
            - root
            - -p$MYSQL_ROOT_PASSWORD
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - mysql
            - -h
            - localhost
            - -u
            - root
            - -p$MYSQL_ROOT_PASSWORD
            - -e
            - "SELECT 1"
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/my.cnf
          subPath: my.cnf
        - name: mysql-ssl
          mountPath: /etc/mysql/ssl
          readOnly: true
        - name: mysql-logs
          mountPath: /var/log/mysql
        # Script de inicializaci√≥n
        - name: mysql-init-scripts
          mountPath: /docker-entrypoint-initdb.d
      
      # MySQL Exporter para m√©tricas
      - name: mysql-exporter
        image: prom/mysqld-exporter:v0.14.0
        imagePullPolicy: IfNotPresent
        env:
        - name: DATA_SOURCE_NAME
          value: "root:$(MYSQL_ROOT_PASSWORD)@(localhost:3306)/"
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretRef:
              name: database-sealed-secrets
              key: mysql-root-password
        ports:
        - name: metrics
          containerPort: 9104
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9104
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /metrics
            port: 9104
          initialDelaySeconds: 10
          periodSeconds: 10
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      
      volumes:
      - name: mysql-config
        configMap:
          name: mysql-master-config
      - name: mysql-ssl
        secret:
          secretName: mysql-ssl-certificates
          defaultMode: 0400
      - name: mysql-logs
        emptyDir: {}
      - name: mysql-init-scripts
        configMap:
          name: mysql-init-scripts
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
      labels:
        app: mysql
        tier: master
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: azure-disk-premium-ssd
      resources:
        requests:
          storage: 50Gi

---
# MySQL Slave StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-slave
  namespace: ecommerce-production
  labels:
    app: mysql
    component: database
    tier: slave
spec:
  serviceName: mysql-slave
  replicas: 2
  selector:
    matchLabels:
      app: mysql
      tier: slave
  template:
    metadata:
      labels:
        app: mysql
        component: database
        tier: slave
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9104"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
      initContainers:
      # Init container para configurar slave
      - name: init-mysql-slave
        image: mysql:8.0
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          echo "üîß Initializing MySQL Slave..."
          
          # Crear directorios necesarios
          mkdir -p /var/lib/mysql/mysql
          mkdir -p /var/log/mysql
          
          # Configurar permisos
          chown -R mysql:mysql /var/lib/mysql
          chown -R mysql:mysql /var/log/mysql
          chmod 755 /var/lib/mysql
          chmod 755 /var/log/mysql
          
          echo "‚úÖ MySQL Slave initialization completed"
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-logs
          mountPath: /var/log/mysql
      containers:
      # MySQL Slave container
      - name: mysql
        image: mysql:8.0
        imagePullPolicy: IfNotPresent
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretRef:
              name: database-sealed-secrets
              key: mysql-root-password
        - name: MYSQL_REPLICATION_USER
          value: "replicator"
        - name: MYSQL_REPLICATION_PASSWORD
          valueFrom:
            secretRef:
              name: database-sealed-secrets
              key: mysql-replication-password
        - name: MYSQL_MASTER_HOST
          value: "mysql-master"
        - name: MYSQL_MASTER_PORT
          value: "3306"
        ports:
        - name: mysql
          containerPort: 3306
          protocol: TCP
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
            - -u
            - root
            - -p$MYSQL_ROOT_PASSWORD
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - mysql
            - -h
            - localhost
            - -u
            - root
            - -p$MYSQL_ROOT_PASSWORD
            - -e
            - "SELECT 1"
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/my.cnf
          subPath: my.cnf
        - name: mysql-ssl
          mountPath: /etc/mysql/ssl
          readOnly: true
        - name: mysql-logs
          mountPath: /var/log/mysql
        - name: mysql-slave-scripts
          mountPath: /docker-entrypoint-initdb.d
      
      # MySQL Exporter para m√©tricas del slave
      - name: mysql-exporter
        image: prom/mysqld-exporter:v0.14.0
        imagePullPolicy: IfNotPresent
        env:
        - name: DATA_SOURCE_NAME
          value: "root:$(MYSQL_ROOT_PASSWORD)@(localhost:3306)/"
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretRef:
              name: database-sealed-secrets
              key: mysql-root-password
        ports:
        - name: metrics
          containerPort: 9104
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9104
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /metrics
            port: 9104
          initialDelaySeconds: 10
          periodSeconds: 10
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      
      volumes:
      - name: mysql-config
        configMap:
          name: mysql-slave-config
      - name: mysql-ssl
        secret:
          secretName: mysql-ssl-certificates
          defaultMode: 0400
      - name: mysql-logs
        emptyDir: {}
      - name: mysql-slave-scripts
        configMap:
          name: mysql-slave-scripts
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
      labels:
        app: mysql
        tier: slave
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: azure-disk-premium-ssd
      resources:
        requests:
          storage: 50Gi

---
# Service para MySQL Master (escritura)
apiVersion: v1
kind: Service
metadata:
  name: mysql-master
  namespace: ecommerce-production
  labels:
    app: mysql
    tier: master
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: mysql
    port: 3306
    targetPort: 3306
    protocol: TCP
  - name: metrics
    port: 9104
    targetPort: 9104
    protocol: TCP
  selector:
    app: mysql
    tier: master
---
# Service para MySQL Slave (lectura)
apiVersion: v1
kind: Service
metadata:
  name: mysql-slave
  namespace: ecommerce-production
  labels:
    app: mysql
    tier: slave
spec:
  type: ClusterIP
  ports:
  - name: mysql
    port: 3306
    targetPort: 3306
    protocol: TCP
  - name: metrics
    port: 9104
    targetPort: 9104
    protocol: TCP
  selector:
    app: mysql
    tier: slave
---
# Service para lecturas (balancear entre slaves)
apiVersion: v1
kind: Service
metadata:
  name: mysql-read
  namespace: ecommerce-production
  labels:
    app: mysql
    tier: read
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: nlb
spec:
  type: ClusterIP
  ports:
  - name: mysql
    port: 3306
    targetPort: 3306
    protocol: TCP
  selector:
    app: mysql
    tier: slave
  sessionAffinity: None