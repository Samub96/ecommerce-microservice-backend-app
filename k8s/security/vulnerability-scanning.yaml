# Esc√°ner de Vulnerabilidades con Trivy
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trivy-operator
  namespace: ecommerce-dev
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: trivy-operator
rules:
- apiGroups: [""]
  resources: ["pods", "services", "secrets", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: trivy-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: trivy-operator
subjects:
- kind: ServiceAccount
  name: trivy-operator
  namespace: ecommerce-dev
---
# Job de escaneo de vulnerabilidades para todas las im√°genes
apiVersion: batch/v1
kind: Job
metadata:
  name: vulnerability-scan-ecommerce
  namespace: ecommerce-dev
spec:
  template:
    metadata:
      labels:
        app: vulnerability-scanner
    spec:
      serviceAccountName: trivy-operator
      containers:
      - name: trivy-scanner
        image: aquasec/trivy:0.46.0
        command:
        - /bin/sh
        - -c
        - |
          echo "üîç Iniciando escaneo de vulnerabilidades..."
          
          # Lista de im√°genes a escanear
          images=(
            "selimhorri/api-gateway-ecommerce-boot:0.1.0"
            "selimhorri/user-service-ecommerce-boot:0.1.0"
            "selimhorri/product-service-ecommerce-boot:0.1.0"
            "selimhorri/order-service-ecommerce-boot:0.1.0"
            "selimhorri/payment-service-ecommerce-boot:0.1.0"
            "selimhorri/shipping-service-ecommerce-boot:0.1.0"
            "selimhorri/favourite-service-ecommerce-boot:0.1.0"
            "selimhorri/service-discovery-ecommerce-boot:0.1.0"
            "samub18/cloud-config-ecommerce-boot:0.1.0"
            "openzipkin/zipkin:latest"
          )
          
          # Crear directorio de reportes
          mkdir -p /tmp/scan-reports
          
          # Escanear cada imagen
          for image in "${images[@]}"; do
            echo "üìä Escaneando $image..."
            
            # Escaneo completo con reporte JSON
            trivy image --format json --output /tmp/scan-reports/$(echo $image | tr '/' '-' | tr ':' '-').json $image
            
            # Escaneo de vulnerabilidades cr√≠ticas y altas
            echo "üö® Vulnerabilidades CR√çTICAS y ALTAS para $image:"
            trivy image --severity CRITICAL,HIGH --format table $image
            
            echo "---"
          done
          
          echo "‚úÖ Escaneo completado. Reportes guardados en /tmp/scan-reports/"
        volumeMounts:
        - name: scan-reports
          mountPath: /tmp/scan-reports
      volumes:
      - name: scan-reports
        emptyDir: {}
      restartPolicy: Never
  backoffLimit: 4
---
# CronJob para escaneos peri√≥dicos
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scheduled-vulnerability-scan
  namespace: ecommerce-dev
spec:
  schedule: "0 2 * * 0"  # Cada domingo a las 2 AM
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: scheduled-vulnerability-scanner
        spec:
          serviceAccountName: trivy-operator
          containers:
          - name: trivy-scheduler
            image: aquasec/trivy:0.46.0
            command:
            - /bin/sh
            - -c
            - |
              echo "üïê Escaneo programado iniciado: $(date)"
              
              # Actualizar base de datos de vulnerabilidades
              trivy image --download-db-only
              
              # Lista de im√°genes cr√≠ticas
              critical_images=(
                "selimhorri/api-gateway-ecommerce-boot:0.1.0"
                "selimhorri/user-service-ecommerce-boot:0.1.0"
                "selimhorri/payment-service-ecommerce-boot:0.1.0"
              )
              
              # Escanear im√°genes cr√≠ticas
              for image in "${critical_images[@]}"; do
                echo "üî¥ Escaneo cr√≠tico: $image"
                
                # Solo mostrar vulnerabilidades cr√≠ticas
                vuln_count=$(trivy image --severity CRITICAL --format json $image | jq '.Results[].Vulnerabilities | length')
                
                if [ "$vuln_count" -gt 0 ]; then
                  echo "‚ö†Ô∏è  ALERTA: $vuln_count vulnerabilidades cr√≠ticas encontradas en $image"
                  trivy image --severity CRITICAL --format table $image
                fi
              done
              
              echo "‚úÖ Escaneo programado completado: $(date)"
          restartPolicy: OnFailure
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
---
# Secret para autenticaci√≥n con registro de im√°genes
apiVersion: v1
kind: Secret
metadata:
  name: vulnerability-scan-config
  namespace: ecommerce-dev
type: Opaque
data:
  # Configuraci√≥n de Trivy (base64 encoded)
  config.yaml: |
    Y2hlY2s6CiAgZGlzYWJsZXJzOgogICAgLSBzZWNyZXQKICBza2lwLWZpbGVzOgogICAgLSAiKi50bXAi
    CiAgICAtICIqLmxvZyIKZGI6CiAgcmVwb3NpdG9yeToKICAgIGdoY3IuaW86IGFxdWFzZWN1cml0eS90
    cml2eS1kYgo=