apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation-cronjob
  namespace: ecommerce-dev
  labels:
    app: secret-rotation
    component: security
spec:
  # Ejecutar cada domingo a las 2 AM (rotaci√≥n semanal)
  schedule: "0 2 * * 0"
  concurrencyPolicy: Forbid # No permitir ejecuciones concurrentes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app: secret-rotation
        component: security
    spec:
      template:
        metadata:
          labels:
            app: secret-rotation
            component: security
        spec:
          serviceAccountName: secret-rotation-sa
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 2000
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: secret-rotator
            image: bitnami/kubectl:1.28
            imagePullPolicy: IfNotPresent
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
            command:
            - /bin/bash
            - -c
            - |
              # Instalar kubeseal y herramientas necesarias
              echo "üì¶ Instalando herramientas necesarias..."
              
              # Crear directorio temporal escribible
              mkdir -p /tmp/rotation-work
              cd /tmp/rotation-work
              
              # Descargar kubeseal
              curl -L -o kubeseal.tar.gz https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.3/kubeseal-0.24.3-linux-amd64.tar.gz
              tar -xzf kubeseal.tar.gz
              chmod +x kubeseal
              export PATH="/tmp/rotation-work:$PATH"
              
              # Verificar herramientas
              kubectl version --client
              ./kubeseal --version
              
              echo "üîÑ Iniciando rotaci√≥n de secretos..."
              
              # Funci√≥n para generar passwords seguros
              generate_password() {
                  openssl rand -base64 32
              }
              
              generate_jwt_secret() {
                  openssl rand -hex 64
              }
              
              # Rotar secretos JWT (cr√≠ticos, rotaci√≥n semanal)
              echo "üîë Rotando secretos JWT..."
              NEW_JWT_SECRET=$(generate_jwt_secret)
              NEW_JWT_SIGNING_KEY=$(generate_jwt_secret)
              
              kubectl create secret generic jwt-secrets \
                  --from-literal=jwt-secret="$NEW_JWT_SECRET" \
                  --from-literal=jwt-signing-key="$NEW_JWT_SIGNING_KEY" \
                  --dry-run=client -o yaml | \
              ./kubeseal --controller-namespace sealed-secrets --controller-name sealed-secrets-controller \
                  --format yaml --name jwt-sealed-secrets --namespace ecommerce-dev > jwt-sealed-new.yaml
              
              kubectl apply -f jwt-sealed-new.yaml
              
              # Esperar que el secret est√© disponible
              kubectl wait --for=condition=Complete --timeout=60s secret/jwt-sealed-secrets -n ecommerce-dev || true
              
              # Reiniciar servicios que usan JWT con rolling update
              kubectl rollout restart deployment/api-gateway -n ecommerce-dev
              kubectl rollout restart deployment/user-service -n ecommerce-dev
              
              echo "‚úÖ Secretos JWT rotados y servicios reiniciados"
              
              # Verificar que los deployments est√°n listos
              kubectl rollout status deployment/api-gateway -n ecommerce-dev --timeout=300s
              kubectl rollout status deployment/user-service -n ecommerce-dev --timeout=300s
              
              # Limpiar certificados TLS para forzar renovaci√≥n (mensual)
              CURRENT_WEEK=$(date +%U)
              if [ $((CURRENT_WEEK % 4)) -eq 0 ]; then
                echo "üîí Rotaci√≥n mensual de certificados TLS..."
                kubectl delete certificate api-gateway-tls -n ecommerce-dev --ignore-not-found=true
                kubectl delete certificate admin-services-tls -n ecommerce-dev --ignore-not-found=true
                
                # Esperar recreaci√≥n autom√°tica por cert-manager
                sleep 30
                kubectl wait --for=condition=Ready certificate/api-gateway-tls -n ecommerce-dev --timeout=300s || echo "‚ö†Ô∏è  Certificado API Gateway a√∫n en proceso"
                kubectl wait --for=condition=Ready certificate/admin-services-tls -n ecommerce-dev --timeout=300s || echo "‚ö†Ô∏è  Certificado Admin Services a√∫n en proceso"
                echo "‚úÖ Certificados TLS renovados"
              fi
              
              # Generar reporte de estado
              echo "üìä Reporte de rotaci√≥n de secretos:"
              echo "Fecha: $(date)"
              echo "JWT Secrets: ‚úÖ Rotados"
              echo "Deployments reiniciados: ‚úÖ"
              echo "Certificados TLS: $(if [ $((CURRENT_WEEK % 4)) -eq 0 ]; then echo "‚úÖ Renovados"; else echo "‚è© No requerido esta semana"; fi)"
              
              # Verificar salud de los pods
              echo "üè• Verificando salud de servicios cr√≠ticos..."
              kubectl get pods -n ecommerce-dev -l app=api-gateway --no-headers | grep Running || echo "‚ö†Ô∏è  API Gateway no est√° corriendo"
              kubectl get pods -n ecommerce-dev -l app=user-service --no-headers | grep Running || echo "‚ö†Ô∏è  User Service no est√° corriendo"
              
              echo "‚ú® Rotaci√≥n de secretos completada exitosamente!"
            env:
            - name: NAMESPACE
              value: "ecommerce-dev"
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: tmp
            emptyDir: {}
          restartPolicy: OnFailure
          activeDeadlineSeconds: 1800 # 30 minutos m√°ximo
---
# ServiceAccount para el CronJob de rotaci√≥n
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-rotation-sa
  namespace: ecommerce-dev
  labels:
    app: secret-rotation
    component: security
automountServiceAccountToken: true
---
# ClusterRole para gesti√≥n de secretos
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-rotation-role
  labels:
    app: secret-rotation
    component: security
rules:
# Gesti√≥n de sealed secrets
- apiGroups: ["bitnami.com"]
  resources: ["sealedsecrets"]
  verbs: ["get", "list", "create", "update", "patch", "delete"]
# Gesti√≥n de secretos normales
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch", "delete"]
# Gesti√≥n de certificados
- apiGroups: ["cert-manager.io"]
  resources: ["certificates", "certificaterequests"]
  verbs: ["get", "list", "create", "update", "patch", "delete"]
# Gesti√≥n de deployments para rolling updates
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "patch", "update"]
# Verificaci√≥n de pods
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
# Gesti√≥n de jobs
- apiGroups: ["batch"]
  resources: ["jobs"]
  verbs: ["get", "list", "create", "delete"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: secret-rotation-binding
  labels:
    app: secret-rotation
    component: security
subjects:
- kind: ServiceAccount
  name: secret-rotation-sa
  namespace: ecommerce-dev
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: secret-rotation-role
---
# Job manual para rotaci√≥n inmediata
apiVersion: batch/v1
kind: Job
metadata:
  name: secret-rotation-manual
  namespace: ecommerce-dev
  labels:
    app: secret-rotation
    component: security
    type: manual
  annotations:
    description: "Job manual para ejecutar rotaci√≥n de secretos inmediatamente"
spec:
  ttlSecondsAfterFinished: 600 # Limpiar despu√©s de 10 minutos
  template:
    metadata:
      labels:
        app: secret-rotation
        component: security
        type: manual
    spec:
      serviceAccountName: secret-rotation-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: secret-rotator
        image: bitnami/kubectl:1.28
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        command:
        - /bin/bash
        - -c
        - |
          echo "üöÄ Rotaci√≥n manual de secretos iniciada..."
          echo "Fecha: $(date)"
          echo "Usuario: Job Manual"
          echo "---"
          
          # Crear directorio de trabajo
          mkdir -p /tmp/manual-rotation
          cd /tmp/manual-rotation
          
          # Descargar kubeseal
          echo "üì¶ Descargando kubeseal..."
          curl -L -o kubeseal.tar.gz https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.3/kubeseal-0.24.3-linux-amd64.tar.gz
          tar -xzf kubeseal.tar.gz
          chmod +x kubeseal
          
          echo "üîë Generando nuevos secretos JWT..."
          NEW_JWT_SECRET=$(openssl rand -hex 64)
          NEW_JWT_SIGNING_KEY=$(openssl rand -hex 64)
          
          kubectl create secret generic jwt-secrets \
              --from-literal=jwt-secret="$NEW_JWT_SECRET" \
              --from-literal=jwt-signing-key="$NEW_JWT_SIGNING_KEY" \
              --dry-run=client -o yaml | \
          ./kubeseal --controller-namespace sealed-secrets --controller-name sealed-secrets-controller \
              --format yaml --name jwt-sealed-secrets --namespace ecommerce-dev > jwt-manual.yaml
          
          kubectl apply -f jwt-manual.yaml
          
          echo "üîÑ Reiniciando servicios con rolling update..."
          kubectl rollout restart deployment/api-gateway -n ecommerce-dev
          kubectl rollout restart deployment/user-service -n ecommerce-dev
          
          echo "‚è≥ Esperando que los deployments est√©n listos..."
          kubectl rollout status deployment/api-gateway -n ecommerce-dev --timeout=300s
          kubectl rollout status deployment/user-service -n ecommerce-dev --timeout=300s
          
          echo "‚úÖ Rotaci√≥n manual completada exitosamente!"
          echo "üìä Estado actual:"
          kubectl get secrets -n ecommerce-dev | grep sealed
          kubectl get pods -n ecommerce-dev -l app=api-gateway
          kubectl get pods -n ecommerce-dev -l app=user-service
        env:
        - name: MANUAL_ROTATION
          value: "true"
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: tmp
        emptyDir: {}
      restartPolicy: OnFailure
      activeDeadlineSeconds: 900 # 15 minutos para rotaci√≥n manual