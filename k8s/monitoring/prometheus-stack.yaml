# ============================================================================
# PROMETHEUS STACK COMPLETO PARA MONITOREO AVANZADO
# ============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    app: prometheus
    component: monitoring-stack
    prometheus.io/operator: "true"
---
# Prometheus Operator CRDs y configuración
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-operator
  namespace: monitoring
  labels:
    app: prometheus-operator
    component: operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus-operator
  template:
    metadata:
      labels:
        app: prometheus-operator
        component: operator
    spec:
      serviceAccountName: prometheus-operator
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      containers:
      - name: prometheus-operator
        image: quay.io/prometheus-operator/prometheus-operator:v0.68.0
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        args:
        - --kubelet-service=kube-system/kubelet
        - --logtostderr=true
        - --config-reloader-image=quay.io/prometheus-operator/prometheus-config-reloader:v0.68.0
        - --prometheus-instance-selector=prometheus=ecommerce
        - --alertmanager-instance-selector=alertmanager=ecommerce
        - --thanos-ruler-instance-selector=thanos-ruler=ecommerce
        - --secret-field-selector=type!=kubernetes.io/dockercfg,type!=kubernetes.io/service-account-token
        - --web.enable-tls=true
        - --web.cert-file=/etc/tls/private/tls.crt
        - --web.key-file=/etc/tls/private/tls.key
        - --web.client-ca-file=/etc/tls/private/ca.crt
        - --web.tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_256_CBC_SHA
        - --web.tls-min-version=VersionTLS12
        ports:
        - name: https
          containerPort: 8443
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /healthz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        volumeMounts:
        - name: tls-secret
          mountPath: /etc/tls/private
          readOnly: true
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tls-secret
        secret:
          secretName: prometheus-operator-tls
          defaultMode: 0400
      - name: tmp
        emptyDir: {}
---
# Prometheus Server Principal
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: ecommerce-prometheus
  namespace: monitoring
  labels:
    app: prometheus
    prometheus: ecommerce
spec:
  image: quay.io/prometheus/prometheus:v2.47.2
  version: v2.47.2
  replicas: 2
  retention: "30d"
  retentionSize: "50GB"
  
  # Configuración de almacenamiento
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: fast-ssd
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 100Gi
  
  # Configuración de recursos
  resources:
    requests:
      memory: "2Gi"
      cpu: "500m"
    limits:
      memory: "4Gi"
      cpu: "1000m"
  
  # Configuración de service discovery
  serviceAccountName: prometheus-ecommerce
  serviceMonitorSelector:
    matchLabels:
      team: ecommerce
  serviceMonitorNamespaceSelector:
    matchLabels:
      prometheus: ecommerce
  
  # Configuración de reglas
  ruleSelector:
    matchLabels:
      team: ecommerce
      role: alert-rules
  
  # Configuración de alerting
  alerting:
    alertmanagers:
    - namespace: monitoring
      name: ecommerce-alertmanager
      port: web
      scheme: http
      pathPrefix: /
      apiVersion: v2
  
  # Configuración de scraping
  scrapeInterval: "15s"
  scrapeTimeout: "10s"
  evaluationInterval: "15s"
  
  # Configuración de seguridad
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534
  
  # Configuración adicional
  additionalScrapeConfigs:
    name: additional-scrape-configs
    key: prometheus-additional.yaml
  
  # Configuración de Thanos para long-term storage
  thanos:
    image: quay.io/thanos/thanos:v0.32.5
    version: v0.32.5
    objectStorageConfig:
      name: thanos-objstore-config
      key: objstore.yml
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"
  
  # Tolerations y node selectors
  tolerations:
  - key: node.kubernetes.io/disk-pressure
    operator: Exists
    effect: NoSchedule
  
  nodeSelector:
    kubernetes.io/os: linux
  
  # Configuración de alta disponibilidad
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
          topologyKey: kubernetes.io/hostname

---
# Alertmanager para gestión de alertas
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  name: ecommerce-alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
    alertmanager: ecommerce
spec:
  image: quay.io/prometheus/alertmanager:v0.26.0
  version: v0.26.0
  replicas: 3
  
  # Configuración de almacenamiento
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: general-ssd
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
  
  # Configuración de recursos
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "200m"
  
  # Configuración de seguridad
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534
  
  # Configuración de alta disponibilidad
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: alertmanager
          topologyKey: kubernetes.io/hostname
  
  # Configuración de alertas
  configSecret: alertmanager-ecommerce-config
  retention: "120h"
  
  # Configuración de clustering
  forceEnableClusterMode: true
  
  nodeSelector:
    kubernetes.io/os: linux

---
# ServiceAccount para Prometheus
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-ecommerce
  namespace: monitoring
  labels:
    app: prometheus
    component: service-account
---
# ServiceAccount para Prometheus Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-operator
  namespace: monitoring
  labels:
    app: prometheus-operator
    component: service-account
---
# ClusterRole para Prometheus
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-ecommerce
  labels:
    app: prometheus
    component: rbac
rules:
# Permisos para discovery de servicios
- apiGroups: [""]
  resources: ["services", "endpoints", "pods", "nodes", "nodes/proxy", "nodes/metrics"]
  verbs: ["get", "list", "watch"]
# Permisos para métricas de kubelet
- apiGroups: [""]
  resources: ["services/proxy"]
  verbs: ["get"]
# Permisos para ConfigMaps
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get"]
# Permisos para métricas de ingress
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
# Permisos para ServiceMonitors
- apiGroups: ["monitoring.coreos.com"]
  resources: ["servicemonitors", "podmonitors", "prometheusrules"]
  verbs: ["get", "list", "watch"]
# Permisos para métricas de pods
- nonResourceURLs: ["/metrics", "/metrics/cadvisor"]
  verbs: ["get"]
---
# ClusterRole para Prometheus Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-operator
  labels:
    app: prometheus-operator
    component: rbac
rules:
# Gestión de CustomResourceDefinitions
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["create", "get", "list", "patch", "update", "watch"]
# Gestión de recursos de monitoreo
- apiGroups: ["monitoring.coreos.com"]
  resources: ["*"]
  verbs: ["*"]
# Gestión de StatefulSets y Deployments
- apiGroups: ["apps"]
  resources: ["statefulsets", "deployments"]
  verbs: ["*"]
# Gestión de servicios y configuración
- apiGroups: [""]
  resources: ["configmaps", "secrets", "services", "serviceaccounts", "endpoints"]
  verbs: ["*"]
# Gestión de roles y bindings
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
  verbs: ["*"]
# Monitoreo de pods y nodos
- apiGroups: [""]
  resources: ["pods", "nodes", "nodes/metrics", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
---
# ClusterRoleBindings
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-ecommerce
  labels:
    app: prometheus
    component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-ecommerce
subjects:
- kind: ServiceAccount
  name: prometheus-ecommerce
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-operator
  labels:
    app: prometheus-operator
    component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-operator
subjects:
- kind: ServiceAccount
  name: prometheus-operator
  namespace: monitoring
---
# Service para Prometheus
apiVersion: v1
kind: Service
metadata:
  name: prometheus-ecommerce
  namespace: monitoring
  labels:
    app: prometheus
    component: server
spec:
  type: ClusterIP
  ports:
  - name: web
    port: 9090
    targetPort: 9090
    protocol: TCP
  selector:
    app.kubernetes.io/name: prometheus
    prometheus: ecommerce
---
# Service para Alertmanager
apiVersion: v1
kind: Service
metadata:
  name: alertmanager-ecommerce
  namespace: monitoring
  labels:
    app: alertmanager
    component: server
spec:
  type: ClusterIP
  ports:
  - name: web
    port: 9093
    targetPort: 9093
    protocol: TCP
  - name: mesh-tcp
    port: 9094
    targetPort: 9094
    protocol: TCP
  - name: mesh-udp
    port: 9094
    targetPort: 9094
    protocol: UDP
  selector:
    app.kubernetes.io/name: alertmanager
    alertmanager: ecommerce